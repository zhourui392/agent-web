<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Web 控制台</title>
  <!-- Element Plus CSS -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
  <!-- Element Plus Icons -->
  <link rel="stylesheet" href="https://unpkg.com/@element-plus/icons-vue/dist/index.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    #app {
      height: 100%;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f5f7fa;
    }
    .chat-message {
      margin-bottom: 16px;
    }
    .message-user {
      background: #409eff;
      color: white;
      padding: 12px 16px;
      border-radius: 12px 12px 4px 12px;
      max-width: 70%;
      margin-left: auto;
      word-wrap: break-word;
    }
    .message-agent {
      background: white;
      padding: 12px 16px;
      border-radius: 12px 12px 12px 4px;
      max-width: 85%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      white-space: pre-wrap;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
    }
    .message-system {
      background: #e1f3d8;
      color: #67c23a;
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 13px;
    }
    .message-error {
      background: #fef0f0;
      color: #f56c6c;
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 13px;
    }
    .chat-input-area {
      padding: 16px;
      background: white;
      border-top: 1px solid #ebeef5;
    }
    .folder-item {
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .folder-item:hover {
      background: #f5f7fa;
    }
    .session-info {
      padding: 12px;
      background: #f0f9ff;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 13px;
      color: #409eff;
    }
    .el-aside {
      background: #fafafa;
      border-right: 1px solid #ebeef5;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="app">
    <el-container style="height: 100%">
      <!-- 侧边栏 -->
      <el-aside width="320px">
        <div style="padding: 20px;">
          <!-- 工作目录选择 -->
          <el-card shadow="hover" style="margin-bottom: 20px;">
            <template #header>
              <div style="display: flex; align-items: center;">
                <el-icon><Folder /></el-icon>
                <span style="margin-left: 8px; font-weight: 600;">工作目录</span>
              </div>
            </template>

            <el-form label-position="top" size="default">
              <el-form-item label="根路径">
                <el-select v-model="selectedRoot" placeholder="选择根路径" style="width: 100%;" @change="handleRootChange">
                  <el-option v-for="root in roots" :key="root" :label="root" :value="root"></el-option>
                </el-select>
              </el-form-item>

              <el-form-item label="当前路径">
                <el-input v-model="currentPath" readonly>
                  <template #prefix>
                    <el-icon><FolderOpened /></el-icon>
                  </template>
                </el-input>
              </el-form-item>
            </el-form>

            <!-- 文件夹列表 -->
            <el-scrollbar height="300px">
              <div v-for="item in folderList" :key="item.path" class="folder-item" @click="loadList(item.path)">
                <el-icon><Folder /></el-icon>
                <span style="margin-left: 8px;">{{ item.name || item.path }}</span>
              </div>
              <el-empty v-if="folderList.length === 0" description="没有子目录" :image-size="60"></el-empty>
            </el-scrollbar>
          </el-card>

          <!-- Agent 设置 -->
          <el-card shadow="hover">
            <template #header>
              <div style="display: flex; align-items: center;">
                <el-icon><Avatar /></el-icon>
                <span style="margin-left: 8px; font-weight: 600;">Agent 设置</span>
              </div>
            </template>

            <el-form label-position="top" size="default">
              <el-form-item label="Agent 类型">
                <el-input value="CLAUDE (Sonnet 4.5)" readonly></el-input>
              </el-form-item>

              <el-button type="primary" style="width: 100%; margin-bottom: 12px;" @click="startSession" :loading="starting" :disabled="!currentPath">
                <el-icon><Connection /></el-icon>
                <span>启动会话</span>
              </el-button>

              <el-button style="width: 100%;" @click="clearContext" :disabled="!sessionId">
                <el-icon><Delete /></el-icon>
                <span>清除上下文</span>
              </el-button>
            </el-form>

            <!-- 会话信息 -->
            <div v-if="sessionId" class="session-info">
              <div><strong>会话 ID：</strong>{{ sessionId.substring(0, 8) }}...</div>
              <div><strong>Agent：</strong>CLAUDE</div>
              <div><strong>目录：</strong>{{ workingDir }}</div>
              <div v-if="resumeId"><strong>Resume ID：</strong>{{ resumeId.substring(0, 16) }}...</div>
            </div>
          </el-card>

          <!-- 用户信息 -->
          <el-card shadow="hover" style="margin-top: 20px;">
            <template #header>
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <el-icon><User /></el-icon>
                  <span style="margin-left: 8px; font-weight: 600;">用户信息</span>
                </div>
              </div>
            </template>
            <div style="margin-bottom: 12px;">
              <strong>用户名：</strong>{{ username }}
            </div>
            <el-button type="danger" style="width: 100%;" @click="handleLogout">
              <el-icon><SwitchButton /></el-icon>
              <span>退出登录</span>
            </el-button>
          </el-card>
        </div>
      </el-aside>

      <!-- 主内容区 -->
      <el-main style="padding: 0;">
        <div class="chat-container">
          <!-- 聊天消息区 -->
          <div class="chat-messages" ref="chatContainer">
            <div v-for="(msg, index) in messages" :key="index" class="chat-message">
              <div v-if="msg.role === 'user'" style="display: flex; justify-content: flex-end;">
                <div class="message-user">{{ msg.text }}</div>
              </div>
              <div v-else-if="msg.role === 'agent'">
                <div class="message-agent">{{ msg.text }}</div>
              </div>
              <div v-else-if="msg.role === 'system'">
                <div class="message-system">{{ msg.text }}</div>
              </div>
              <div v-else-if="msg.role === 'error'">
                <div class="message-error">{{ msg.text }}</div>
              </div>
            </div>

            <el-empty v-if="messages.length === 0" description="请选择工作目录并启动会话" :image-size="120"></el-empty>
          </div>

          <!-- 输入区 -->
          <div class="chat-input-area">
            <el-input
              v-model="userInput"
              type="textarea"
              :rows="3"
              placeholder="输入你的指令，例如：在当前目录初始化一个 Spring Boot 项目"
              @keydown.enter.exact.prevent="sendMessageStream"
              @keydown.ctrl.enter.exact.prevent="insertNewline"
              :disabled="!sessionId"
            ></el-input>
            <div style="margin-top: 12px; display: flex; justify-content: space-between; align-items: center;">
              <div style="color: #909399; font-size: 13px;">
                <span v-if="sessionId">Enter 发送 | Ctrl+Enter 换行</span>
                <span v-else>请先启动会话</span>
              </div>
              <div>
                <el-button type="primary" @click="sendMessageStream" :loading="sending" :disabled="!sessionId || !userInput.trim()">
                  <el-icon><Connection /></el-icon>
                  <span>发送</span>
                </el-button>
              </div>
            </div>
          </div>
        </div>
      </el-main>
    </el-container>
  </div>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Element Plus -->
  <script src="https://unpkg.com/element-plus"></script>
  <!-- Element Plus Icons -->
  <script src="https://unpkg.com/@element-plus/icons-vue"></script>

  <script>
    const { createApp, ref, reactive, onMounted, nextTick } = Vue;

    createApp({
      setup() {
        // 数据
        const roots = ref([]);
        const selectedRoot = ref('');
        const currentPath = ref('');
        const folderList = ref([]);
        const agentType = ref('CLAUDE');
        const sessionId = ref('');
        const workingDir = ref('');
        const resumeId = ref('');
        const username = ref('');
        const messages = ref([]);
        const userInput = ref('');
        const starting = ref(false);
        const sending = ref(false);
        const chatContainer = ref(null);

        // 检查登录状态
        const checkAuth = async () => {
          try {
            const res = await fetch('/api/auth/check');
            if (!res.ok) {
              window.location.href = '/login.html';
              return;
            }
            const data = await res.json();
            if (!data.loggedIn) {
              window.location.href = '/login.html';
              return;
            }
            username.value = data.username || 'admin';
          } catch (error) {
            window.location.href = '/login.html';
          }
        };

        // 退出登录
        const handleLogout = async () => {
          try {
            await fetch('/api/auth/logout', { method: 'POST' });
            ElementPlus.ElMessage.success('已退出登录');
            setTimeout(() => {
              window.location.href = '/login.html';
            }, 500);
          } catch (error) {
            ElementPlus.ElMessage.error('退出失败');
          }
        };

        // 方法
        const init = async () => {
          try {
            const data = await fetch('/api/fs/roots').then(r => r.json());
            roots.value = data;
            if (data.length > 0) {
              selectedRoot.value = data[0];
              currentPath.value = data[0];
              await loadList(data[0]);
            }
          } catch (error) {
            ElementPlus.ElMessage.error('加载根路径失败');
          }
        };

        const handleRootChange = async () => {
          currentPath.value = selectedRoot.value;
          await loadList(selectedRoot.value);
        };

        const loadList = async (path) => {
          if (path) currentPath.value = path;
          try {
            const data = await fetch('/api/fs/list?path=' + encodeURIComponent(currentPath.value))
              .then(r => {
                if (!r.ok) throw new Error('加载失败');
                return r.json();
              });
            folderList.value = data;
          } catch (error) {
            ElementPlus.ElMessage.error('加载目录失败: ' + error.message);
          }
        };

        const startSession = async () => {
          starting.value = true;
          try {
            const req = { agentType: agentType.value, workingDir: currentPath.value };
            const res = await fetch('/api/chat/session', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(req)
            });
            if (!res.ok) {
              const text = await res.text();
              throw new Error(text);
            }
            const data = await res.json();
            sessionId.value = data.sessionId;
            workingDir.value = data.workingDir;
            resumeId.value = ''; // 清除旧的 resume ID
            addMessage('system', '会话已创建，工作目录：' + data.workingDir);
            ElementPlus.ElMessage.success('会话启动成功');
          } catch (error) {
            ElementPlus.ElMessage.error('启动失败: ' + error.message);
          } finally {
            starting.value = false;
          }
        };

        const addMessage = (role, text) => {
          messages.value.push({ role, text });
          nextTick(() => {
            if (chatContainer.value) {
              chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
            }
          });
        };

        const insertNewline = () => {
          const textarea = document.querySelector('textarea');
          if (textarea) {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const value = userInput.value;
            userInput.value = value.substring(0, start) + '\n' + value.substring(end);
            nextTick(() => {
              textarea.selectionStart = textarea.selectionEnd = start + 1;
            });
          }
        };

        const clearContext = () => {
          resumeId.value = '';
          addMessage('system', '上下文已清除');
          ElementPlus.ElMessage.success('上下文已清除');
        };

        const sendMessageStream = () => {
          if (!sessionId.value || !userInput.value.trim() || sending.value) return;

          const message = userInput.value.trim();
          addMessage('user', message);
          userInput.value = '';
          sending.value = true;

          // 创建消息占位
          const msgIndex = messages.value.length;
          addMessage('agent', '');

          let url = '/api/chat/session/' + encodeURIComponent(sessionId.value) + '/message/stream?message=' + encodeURIComponent(message);
          if (resumeId.value) {
            url += '&resumeId=' + encodeURIComponent(resumeId.value);
          }

          const es = new EventSource(url);
          let buffer = '';

          es.addEventListener('chunk', (e) => {
            try {
              const json = JSON.parse(e.data);

              // 提取 resume ID (从 session_id 字段)
              if (json.session_id && !resumeId.value) {
                resumeId.value = json.session_id;
              }

              // 提取文本内容
              if (json.type === 'stream_event' && json.event) {
                // content_block_delta 包含增量文本
                if (json.event.type === 'content_block_delta' && json.event.delta && json.event.delta.text) {
                  buffer += json.event.delta.text;
                }
              } else if (json.type === 'assistant' && json.message && json.message.content) {
                // 最终完整消息（如果有的话，使用它替换累积的内容）
                for (const block of json.message.content) {
                  if (block.type === 'text' && block.text) {
                    buffer = block.text;
                  }
                }
              } else if (json.type === 'result' && json.result) {
                // 使用 result 类型的完整结果文本
                buffer = json.result;
              }

              messages.value[msgIndex].text = buffer;
              nextTick(() => {
                if (chatContainer.value) {
                  chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                }
              });
            } catch (err) {
              console.error('Failed to parse JSON:', e.data, err);
            }
          });

          es.addEventListener('exit', (e) => {
            addMessage('system', '进程退出码: ' + e.data);
            es.close();
            sending.value = false;
          });

          es.addEventListener('error', (e) => {
            addMessage('error', e.data || 'SSE 连接错误');
            es.close();
            sending.value = false;
          });

          es.onerror = () => {
            es.close();
            sending.value = false;
          };
        };

        onMounted(async () => {
          await checkAuth();
          await init();
        });

        return {
          roots,
          selectedRoot,
          currentPath,
          folderList,
          agentType,
          sessionId,
          workingDir,
          resumeId,
          username,
          messages,
          userInput,
          starting,
          sending,
          chatContainer,
          handleRootChange,
          loadList,
          startSession,
          insertNewline,
          clearContext,
          sendMessageStream,
          handleLogout
        };
      }
    }).use(ElementPlus).mount('#app');
  </script>
</body>
</html>
